<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>SenpaiJepang Unified Dashboard</title>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=IBM+Plex+Mono:wght@400;600&display=swap');

      :root {
        --bg-0: #f4f7fb;
        --bg-1: #e4edf8;
        --bg-2: #d5e7ff;
        --panel: rgba(255, 255, 255, 0.9);
        --panel-border: rgba(16, 48, 89, 0.2);
        --text: #14263f;
        --muted: #4f6684;
        --accent: #0b5fff;
        --accent-soft: rgba(11, 95, 255, 0.12);
        --ok: #1f8d5a;
        --warn: #8d6b1f;
        --danger: #a8293e;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background:
          radial-gradient(circle at 10% 10%, rgba(11, 95, 255, 0.15), transparent 40%),
          radial-gradient(circle at 90% 20%, rgba(43, 151, 255, 0.14), transparent 45%),
          linear-gradient(150deg, var(--bg-0), var(--bg-1), var(--bg-2));
        color: var(--text);
        font-family: 'Space Grotesk', sans-serif;
      }

      .shell {
        max-width: 1240px;
        margin: 0 auto;
        padding: 24px 18px 30px;
      }

      .hero {
        display: grid;
        grid-template-columns: minmax(0, 1fr) 320px;
        gap: 14px;
      }

      .panel {
        border: 1px solid var(--panel-border);
        border-radius: 18px;
        background: var(--panel);
        backdrop-filter: blur(6px);
        box-shadow: 0 20px 46px rgba(31, 65, 112, 0.08);
      }

      .hero-main {
        padding: 18px;
      }

      .hero-main h1 {
        margin: 0;
        font-size: clamp(1.5rem, 3vw, 2rem);
      }

      .hero-main p {
        margin: 10px 0 0;
        color: var(--muted);
      }

      .hero-side {
        padding: 16px;
        display: grid;
        gap: 10px;
      }

      .field {
        display: grid;
        gap: 6px;
      }

      .field label {
        font-size: 12px;
        color: var(--muted);
        letter-spacing: 0.05em;
        text-transform: uppercase;
      }

      .field input,
      .field select,
      .field textarea {
        width: 100%;
        border-radius: 10px;
        border: 1px solid rgba(20, 38, 63, 0.2);
        padding: 10px 12px;
        background: #fff;
        color: var(--text);
        font-family: 'IBM Plex Mono', monospace;
      }

      .field textarea {
        min-height: 82px;
        resize: vertical;
      }

      .chip-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 12px;
      }

      .chip {
        border: 1px solid rgba(20, 38, 63, 0.18);
        border-radius: 999px;
        padding: 5px 10px;
        font-size: 12px;
        font-family: 'IBM Plex Mono', monospace;
        background: #fff;
      }

      .chip.active {
        border-color: rgba(11, 95, 255, 0.45);
        background: var(--accent-soft);
        color: #0a3f97;
      }

      .section {
        margin-top: 14px;
      }

      .cards {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 10px;
      }

      .card {
        padding: 14px;
      }

      .card h3 {
        margin: 0;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--muted);
      }

      .card .value {
        margin-top: 8px;
        font-size: 24px;
        font-family: 'IBM Plex Mono', monospace;
      }

      .role-lane {
        padding: 16px;
      }

      .role-lane h2 {
        margin: 0;
      }

      .role-lane p {
        margin: 8px 0 0;
        color: var(--muted);
      }

      .action-list {
        margin-top: 10px;
        display: grid;
        gap: 8px;
      }

      .action {
        border-radius: 12px;
        border: 1px solid rgba(20, 38, 63, 0.14);
        padding: 10px;
        background: rgba(255, 255, 255, 0.7);
      }

      .super-admin-lane {
        display: none;
        margin-top: 14px;
        grid-template-columns: 360px minmax(0, 1fr);
        gap: 12px;
      }

      .queue-column,
      .detail-column {
        padding: 14px;
      }

      .queue {
        margin-top: 10px;
        display: grid;
        gap: 8px;
        max-height: 60vh;
        overflow: auto;
      }

      .queue-item {
        border-radius: 10px;
        border: 1px solid rgba(20, 38, 63, 0.16);
        padding: 10px;
        background: rgba(255, 255, 255, 0.8);
        cursor: pointer;
      }

      .queue-item.active {
        border-color: rgba(11, 95, 255, 0.5);
        box-shadow: 0 0 0 2px rgba(11, 95, 255, 0.13) inset;
      }

      .queue-item h4 {
        margin: 0 0 4px;
        font-size: 15px;
      }

      .meta {
        margin: 0;
        font-size: 12px;
        font-family: 'IBM Plex Mono', monospace;
        color: var(--muted);
      }

      .summary {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 8px;
      }

      .summary-card {
        border: 1px solid rgba(20, 38, 63, 0.16);
        border-radius: 12px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.8);
      }

      .summary-card .value {
        margin-top: 6px;
        font-size: 19px;
        font-family: 'IBM Plex Mono', monospace;
      }

      .details {
        margin-top: 10px;
        display: grid;
        grid-template-columns: 1.1fr 0.9fr;
        gap: 10px;
      }

      .stack {
        display: grid;
        gap: 10px;
      }

      .stack article {
        border: 1px solid rgba(20, 38, 63, 0.16);
        border-radius: 12px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.8);
      }

      .kv {
        display: grid;
        grid-template-columns: 170px 1fr;
        gap: 7px;
        padding: 4px 0;
        border-bottom: 1px dashed rgba(20, 38, 63, 0.12);
      }

      .kv .key {
        color: var(--muted);
        font-size: 11px;
        letter-spacing: 0.04em;
        text-transform: uppercase;
      }

      .risk-list,
      .docs,
      .events {
        display: grid;
        gap: 7px;
      }

      .risk-chip {
        border-radius: 999px;
        border: 1px solid rgba(141, 107, 31, 0.36);
        padding: 4px 9px;
        font-size: 11px;
        font-family: 'IBM Plex Mono', monospace;
        color: var(--warn);
        background: rgba(141, 107, 31, 0.12);
        width: fit-content;
      }

      .doc,
      .event {
        border-radius: 10px;
        border: 1px solid rgba(20, 38, 63, 0.12);
        padding: 8px;
        background: #fff;
      }

      .doc a {
        color: #0b5fff;
        word-break: break-all;
      }

      .buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      button {
        border-radius: 10px;
        border: 1px solid rgba(20, 38, 63, 0.2);
        padding: 9px 12px;
        background: #fff;
        color: var(--text);
        cursor: pointer;
        font-family: 'Space Grotesk', sans-serif;
        font-weight: 600;
      }

      button.primary {
        border-color: rgba(11, 95, 255, 0.4);
        background: var(--accent-soft);
      }

      button.ok {
        border-color: rgba(31, 141, 90, 0.45);
        background: rgba(31, 141, 90, 0.14);
      }

      button.warn {
        border-color: rgba(141, 107, 31, 0.45);
        background: rgba(141, 107, 31, 0.14);
      }

      button.danger {
        border-color: rgba(168, 41, 62, 0.45);
        background: rgba(168, 41, 62, 0.14);
      }

      .message {
        min-height: 20px;
        margin: 8px 0 0;
        font-size: 13px;
        font-family: 'IBM Plex Mono', monospace;
      }

      .message.error {
        color: var(--danger);
      }

      .message.ok {
        color: var(--ok);
      }

      .hidden {
        display: none;
      }

      @media (max-width: 1100px) {
        .hero {
          grid-template-columns: 1fr;
        }

        .cards {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .super-admin-lane {
          grid-template-columns: 1fr;
        }

        .summary {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .details {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 640px) {
        .cards,
        .summary {
          grid-template-columns: 1fr;
        }

        .kv {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <header class="hero">
        <section class="panel hero-main">
          <h1>Unified Operations Dashboard</h1>
          <p id="roleSummary">Single web dashboard for LPK, TSK, Kaisha, and Super Admin.</p>
          <div class="chip-row" id="roleChips"></div>
          <div class="chip-row">
            <span class="chip">Web Surface: Dashboard Only</span>
            <span class="chip">Mobile Surface: iOS MVP</span>
          </div>
        </section>

        <aside class="panel hero-side">
          <div class="field">
            <label for="roleSelect">Active Role</label>
            <select id="roleSelect">
              <option value="lpk">LPK</option>
              <option value="tsk">TSK</option>
              <option value="kaisha">Kaisha</option>
              <option value="super_admin">Super Admin</option>
            </select>
          </div>

          <div class="field">
            <label for="apiBase">API Base URL</label>
            <input id="apiBase" value="http://localhost:4000" />
          </div>

          <div class="field" id="adminKeyField">
            <label for="adminKey">Admin API Key</label>
            <input id="adminKey" placeholder="x-admin-api-key" />
          </div>
        </aside>
      </header>

      <section class="section cards" id="roleCards"></section>

      <section class="section panel role-lane">
        <h2 id="laneTitle"></h2>
        <p id="laneDesc"></p>
        <div id="roleActions" class="action-list"></div>
      </section>

      <section id="superAdminLane" class="super-admin-lane">
        <aside class="panel queue-column">
          <h2 style="margin: 0">KYC Review Queue</h2>
          <div class="field" style="margin-top: 10px">
            <label for="statusFilter">Queue Status</label>
            <select id="statusFilter">
              <option value="DEFAULT">DEFAULT (SUBMITTED + MANUAL_REVIEW)</option>
              <option value="ALL">ALL</option>
              <option value="SUBMITTED">SUBMITTED</option>
              <option value="MANUAL_REVIEW">MANUAL_REVIEW</option>
              <option value="VERIFIED">VERIFIED</option>
              <option value="REJECTED">REJECTED</option>
              <option value="CREATED">CREATED</option>
            </select>
          </div>

          <div class="field">
            <label for="queueLimit">Queue Limit</label>
            <input id="queueLimit" type="number" min="1" max="100" value="25" />
          </div>

          <div class="buttons">
            <button id="refreshQueue" class="primary">Refresh Queue</button>
          </div>
          <p id="queueMsg" class="message"></p>

          <div id="queueList" class="queue"></div>
        </aside>

        <main class="panel detail-column">
          <div class="summary" id="summary"></div>

          <section id="details" class="details hidden">
            <div class="stack">
              <article>
                <h3 style="margin-top: 0">Session + User</h3>
                <div id="sessionUserBlock"></div>
                <div>
                  <strong style="font-size: 12px; color: var(--muted)">Risk Flags</strong>
                  <div id="riskFlags" class="risk-list"></div>
                </div>
              </article>

              <article>
                <h3 style="margin-top: 0">Documents</h3>
                <div id="documentsBlock" class="docs"></div>
              </article>
            </div>

            <div class="stack">
              <article>
                <h3 style="margin-top: 0">Review Action</h3>
                <div class="field">
                  <label for="reviewedBy">Reviewed By</label>
                  <input id="reviewedBy" placeholder="ops@senpaijepang.com" />
                </div>
                <div class="field">
                  <label for="reviewReason">Reason</label>
                  <textarea id="reviewReason" placeholder="decision notes"></textarea>
                </div>
                <div class="buttons">
                  <button id="decisionManual" class="warn">Set MANUAL_REVIEW</button>
                  <button id="decisionVerify" class="ok">Set VERIFIED</button>
                  <button id="decisionReject" class="danger">Set REJECTED</button>
                </div>
                <p id="reviewMsg" class="message"></p>
              </article>

              <article>
                <h3 style="margin-top: 0">Status Events</h3>
                <div id="eventsBlock" class="events"></div>
              </article>
            </div>
          </section>
        </main>
      </section>
    </div>

    <script>
      const ROLES = ['lpk', 'tsk', 'kaisha', 'super_admin'];
      const roleView = {
        lpk: {
          label: 'LPK',
          summary: 'LPK lane for partner onboarding pipeline and verification status.',
          cards: [
            ['Partner Leads', '18'],
            ['Pending Validation', '7'],
            ['Ready for Handover', '11'],
            ['Escalations', '2']
          ],
          actions: [
            'Review kelengkapan dokumen partner baru.',
            'Pantau status pengajuan yang menunggu verifikasi TSK.',
            'Kirim eskalasi risiko ke Super Admin bila diperlukan.'
          ]
        },
        tsk: {
          label: 'TSK',
          summary: 'TSK lane for candidate processing, interview flow, and deployment slots.',
          cards: [
            ['Active Intakes', '29'],
            ['Interview Queue', '14'],
            ['Visa Ready', '9'],
            ['At-Risk Cases', '3']
          ],
          actions: [
            'Kelola interview dan status matching kandidat.',
            'Validasi readiness sebelum handover ke Kaisha.',
            'Koordinasikan blocker case dengan LPK dan Super Admin.'
          ]
        },
        kaisha: {
          label: 'Kaisha',
          summary: 'Kaisha lane for hiring decisions, intake capacity, and contract confirmation.',
          cards: [
            ['Open Requests', '12'],
            ['Candidate Shortlist', '24'],
            ['Contract Pending', '5'],
            ['Fulfillment Rate', '82%']
          ],
          actions: [
            'Pantau shortlist kandidat berdasarkan skill dan readiness.',
            'Finalisasi approval hiring dan timeline keberangkatan.',
            'Laporkan mismatch kebutuhan ke TSK/LPK lane.'
          ]
        },
        super_admin: {
          label: 'Super Admin',
          summary: 'Super Admin lane includes trust governance, KYC moderation, and critical incident control.',
          cards: [
            ['Queue Size', '-'],
            ['Submitted', '-'],
            ['Manual Review', '-'],
            ['Resolved (V+R)', '-']
          ],
          actions: [
            'Lakukan review KYC dan audit event secara real-time.',
            'Tetapkan keputusan MANUAL_REVIEW/VERIFIED/REJECTED.',
            'Awasi risiko lintas LPK, TSK, dan Kaisha dari satu lane.'
          ]
        }
      };

      const state = {
        role: 'lpk',
        queue: [],
        selectedSessionId: null
      };

      const els = {
        roleSelect: document.getElementById('roleSelect'),
        roleSummary: document.getElementById('roleSummary'),
        roleCards: document.getElementById('roleCards'),
        laneTitle: document.getElementById('laneTitle'),
        laneDesc: document.getElementById('laneDesc'),
        roleActions: document.getElementById('roleActions'),
        roleChips: document.getElementById('roleChips'),
        superAdminLane: document.getElementById('superAdminLane'),
        apiBase: document.getElementById('apiBase'),
        adminKeyField: document.getElementById('adminKeyField'),
        adminKey: document.getElementById('adminKey'),
        statusFilter: document.getElementById('statusFilter'),
        queueLimit: document.getElementById('queueLimit'),
        refreshQueue: document.getElementById('refreshQueue'),
        queueMsg: document.getElementById('queueMsg'),
        queueList: document.getElementById('queueList'),
        summary: document.getElementById('summary'),
        details: document.getElementById('details'),
        sessionUserBlock: document.getElementById('sessionUserBlock'),
        riskFlags: document.getElementById('riskFlags'),
        documentsBlock: document.getElementById('documentsBlock'),
        eventsBlock: document.getElementById('eventsBlock'),
        reviewedBy: document.getElementById('reviewedBy'),
        reviewReason: document.getElementById('reviewReason'),
        reviewMsg: document.getElementById('reviewMsg'),
        decisionManual: document.getElementById('decisionManual'),
        decisionVerify: document.getElementById('decisionVerify'),
        decisionReject: document.getElementById('decisionReject')
      };

      function setMessage(target, message, type) {
        target.textContent = message || '';
        target.className = 'message';
        if (type) {
          target.classList.add(type);
        }
      }

      function getSelectedItem() {
        return state.queue.find((item) => item.session.id === state.selectedSessionId) || null;
      }

      async function apiRequest(path, { method = 'GET', body } = {}) {
        const base = String(els.apiBase.value || '').replace(/\/+$/, '');
        const adminKey = String(els.adminKey.value || '').trim();
        const headers = {};

        if (path.startsWith('/admin/') && adminKey) {
          headers['x-admin-api-key'] = adminKey;
        }
        if (body) {
          headers['Content-Type'] = 'application/json';
        }

        const response = await fetch(`${base}${path}`, {
          method,
          headers,
          body: body ? JSON.stringify(body) : undefined
        });

        const text = await response.text();
        const data = text ? JSON.parse(text) : null;

        if (!response.ok) {
          const message = data?.error?.message || `HTTP ${response.status}`;
          throw new Error(message);
        }

        return data;
      }

      function renderRoleChips() {
        els.roleChips.innerHTML = '';
        for (const role of ROLES) {
          const chip = document.createElement('span');
          chip.className = 'chip';
          if (role === state.role) {
            chip.classList.add('active');
          }
          chip.textContent = roleView[role].label;
          els.roleChips.appendChild(chip);
        }
      }

      function renderRoleContent() {
        const view = roleView[state.role];
        els.roleSummary.textContent = view.summary;
        els.laneTitle.textContent = `${view.label} Control Lane`;
        els.laneDesc.textContent = view.summary;

        els.roleCards.innerHTML = '';
        for (const [title, value] of view.cards) {
          const card = document.createElement('article');
          card.className = 'panel card';
          const label = document.createElement('h3');
          label.textContent = title;
          const val = document.createElement('div');
          val.className = 'value';
          val.textContent = value;
          card.append(label, val);
          els.roleCards.appendChild(card);
        }

        els.roleActions.innerHTML = '';
        for (const action of view.actions) {
          const row = document.createElement('div');
          row.className = 'action';
          row.textContent = action;
          els.roleActions.appendChild(row);
        }

        const isSuperAdmin = state.role === 'super_admin';
        els.superAdminLane.style.display = isSuperAdmin ? 'grid' : 'none';
        els.adminKeyField.style.display = isSuperAdmin ? 'grid' : 'none';
      }

      function renderSummary() {
        const submitted = state.queue.filter((item) => item.session.status === 'SUBMITTED').length;
        const manual = state.queue.filter((item) => item.session.status === 'MANUAL_REVIEW').length;
        const verified = state.queue.filter((item) => item.session.status === 'VERIFIED').length;
        const rejected = state.queue.filter((item) => item.session.status === 'REJECTED').length;

        const cards = [
          ['Queue Size', state.queue.length],
          ['Submitted', submitted],
          ['Manual Review', manual],
          ['Resolved (V+R)', verified + rejected]
        ];

        els.summary.innerHTML = '';
        for (const [title, value] of cards) {
          const card = document.createElement('div');
          card.className = 'summary-card';
          const label = document.createElement('div');
          label.textContent = title;
          label.style.color = 'var(--muted)';
          label.style.fontSize = '12px';
          const val = document.createElement('div');
          val.className = 'value';
          val.textContent = String(value);
          card.append(label, val);
          els.summary.appendChild(card);
        }
      }

      function renderQueueList() {
        els.queueList.innerHTML = '';
        if (state.queue.length === 0) {
          const empty = document.createElement('p');
          empty.className = 'meta';
          empty.textContent = 'No sessions for selected filter.';
          els.queueList.appendChild(empty);
          return;
        }

        for (const item of state.queue) {
          const card = document.createElement('article');
          card.className = 'queue-item';
          if (item.session.id === state.selectedSessionId) {
            card.classList.add('active');
          }

          const title = document.createElement('h4');
          title.textContent = item.user?.fullName || item.user?.email || item.session.id;

          const status = document.createElement('p');
          status.className = 'meta';
          status.textContent = `${item.session.status} | docs=${item.documentCount}`;

          const secondary = document.createElement('p');
          secondary.className = 'meta';
          secondary.textContent = item.user?.email || 'user not found';

          card.append(title, status, secondary);
          card.addEventListener('click', () => {
            state.selectedSessionId = item.session.id;
            renderDetails();
            renderQueueList();
          });

          els.queueList.appendChild(card);
        }
      }

      function kvRow(key, value) {
        const row = document.createElement('div');
        row.className = 'kv';
        const keyNode = document.createElement('div');
        keyNode.className = 'key';
        keyNode.textContent = key;
        const valueNode = document.createElement('div');
        valueNode.textContent = value ?? '-';
        row.append(keyNode, valueNode);
        return row;
      }

      function renderDetails() {
        const selected = getSelectedItem();
        if (!selected) {
          els.details.classList.add('hidden');
          return;
        }

        els.details.classList.remove('hidden');

        els.sessionUserBlock.innerHTML = '';
        els.sessionUserBlock.append(
          kvRow('Session ID', selected.session.id),
          kvRow('Trust Status', selected.trustStatus),
          kvRow('Provider', selected.session.provider),
          kvRow('Submitted At', selected.session.submittedAt || '-'),
          kvRow('Reviewed By', selected.session.reviewedBy || '-'),
          kvRow('User Name', selected.user?.fullName || '-'),
          kvRow('User Email', selected.user?.email || '-')
        );

        els.riskFlags.innerHTML = '';
        if (!selected.riskFlags || selected.riskFlags.length === 0) {
          const safe = document.createElement('span');
          safe.className = 'risk-chip';
          safe.style.color = 'var(--ok)';
          safe.style.borderColor = 'rgba(31, 141, 90, 0.4)';
          safe.style.background = 'rgba(31, 141, 90, 0.14)';
          safe.textContent = 'NO_ACTIVE_FLAGS';
          els.riskFlags.appendChild(safe);
        } else {
          for (const flag of selected.riskFlags) {
            const chip = document.createElement('span');
            chip.className = 'risk-chip';
            chip.textContent = flag;
            els.riskFlags.appendChild(chip);
          }
        }

        els.documentsBlock.innerHTML = '';
        if (!selected.documents || selected.documents.length === 0) {
          const emptyDoc = document.createElement('div');
          emptyDoc.className = 'doc';
          emptyDoc.textContent = 'No documents uploaded.';
          els.documentsBlock.appendChild(emptyDoc);
        } else {
          for (const doc of selected.documents) {
            const docBox = document.createElement('div');
            docBox.className = 'doc';
            docBox.append(
              kvRow('Type', doc.documentType),
              kvRow('Object Key', doc.objectKey || '-'),
              kvRow('Checksum', doc.checksumSha256),
              kvRow('Created At', doc.createdAt || '-')
            );

            if (doc.fileUrl) {
              const link = document.createElement('a');
              link.href = doc.fileUrl;
              link.target = '_blank';
              link.rel = 'noreferrer noopener';
              link.textContent = doc.fileUrl;
              docBox.appendChild(link);
            }

            els.documentsBlock.appendChild(docBox);
          }
        }

        els.eventsBlock.innerHTML = '';
        const events = selected.events || (selected.lastEvent ? [selected.lastEvent] : []);
        if (events.length === 0) {
          const emptyEvent = document.createElement('div');
          emptyEvent.className = 'event';
          emptyEvent.textContent = 'No events logged.';
          els.eventsBlock.appendChild(emptyEvent);
          return;
        }

        for (const event of events) {
          const eventBox = document.createElement('div');
          eventBox.className = 'event';
          const title = document.createElement('strong');
          title.textContent = `${event.fromStatus || '-'} -> ${event.toStatus}`;
          const meta = document.createElement('p');
          meta.className = 'meta';
          meta.textContent = `${event.actorType} | ${event.actorId || '-'} | ${event.createdAt || '-'}`;
          const reason = document.createElement('p');
          reason.style.margin = '6px 0 0';
          reason.textContent = event.reason || 'no reason';
          eventBox.append(title, meta, reason);
          els.eventsBlock.appendChild(eventBox);
        }
      }

      function renderAllSuperAdmin() {
        renderSummary();
        renderQueueList();
        renderDetails();
      }

      async function loadQueue() {
        if (state.role !== 'super_admin') {
          return;
        }

        setMessage(els.queueMsg, 'Loading queue...');
        try {
          const status = encodeURIComponent(els.statusFilter.value || 'DEFAULT');
          const limit = encodeURIComponent(els.queueLimit.value || '25');
          const data = await apiRequest(`/admin/kyc/review-queue?status=${status}&limit=${limit}`);
          state.queue = data.items || [];

          if (!state.selectedSessionId || !state.queue.some((item) => item.session.id === state.selectedSessionId)) {
            state.selectedSessionId = state.queue[0]?.session.id || null;
          }

          setMessage(els.queueMsg, `Queue loaded (${data.count || 0} items)`, 'ok');
          renderAllSuperAdmin();
        } catch (error) {
          setMessage(els.queueMsg, error.message, 'error');
        }
      }

      async function submitDecision(decision) {
        const selected = getSelectedItem();
        if (!selected) {
          setMessage(els.reviewMsg, 'Select a session first.', 'error');
          return;
        }

        const reviewedBy = String(els.reviewedBy.value || '').trim();
        if (!reviewedBy) {
          setMessage(els.reviewMsg, 'Reviewed By is required.', 'error');
          return;
        }

        setMessage(els.reviewMsg, `Submitting ${decision}...`);
        try {
          await apiRequest('/admin/kyc/review', {
            method: 'POST',
            body: {
              sessionId: selected.session.id,
              decision,
              reviewedBy,
              reason: String(els.reviewReason.value || '').trim() || undefined
            }
          });

          setMessage(els.reviewMsg, `Decision ${decision} saved.`, 'ok');
          await loadQueue();
        } catch (error) {
          setMessage(els.reviewMsg, error.message, 'error');
        }
      }

      function applyRole(role) {
        state.role = ROLES.includes(role) ? role : 'lpk';
        els.roleSelect.value = state.role;
        renderRoleChips();
        renderRoleContent();

        if (state.role === 'super_admin') {
          loadQueue();
        }
      }

      els.roleSelect.addEventListener('change', (event) => applyRole(event.target.value));
      els.refreshQueue.addEventListener('click', loadQueue);
      els.statusFilter.addEventListener('change', loadQueue);
      els.decisionManual.addEventListener('click', () => submitDecision('MANUAL_REVIEW'));
      els.decisionVerify.addEventListener('click', () => submitDecision('VERIFIED'));
      els.decisionReject.addEventListener('click', () => submitDecision('REJECTED'));

      applyRole('lpk');
    </script>
  </body>
</html>
