<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>SenpaiJepang Ops Console</title>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=IBM+Plex+Mono:wght@400;600&display=swap');

      :root {
        --bg-0: #051325;
        --bg-1: #0b243d;
        --panel: rgba(255, 255, 255, 0.08);
        --panel-border: rgba(255, 255, 255, 0.22);
        --text: #edf7ff;
        --muted: #b1c6d8;
        --accent: #3dd9b1;
        --danger: #ff5f5f;
        --warn: #ffbf5a;
        --ok: #53f48f;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background:
          radial-gradient(circle at 90% 0%, rgba(61, 217, 177, 0.16), transparent 45%),
          radial-gradient(circle at 0% 90%, rgba(83, 154, 255, 0.14), transparent 45%),
          linear-gradient(140deg, var(--bg-0), var(--bg-1));
        color: var(--text);
        font-family: 'Space Grotesk', sans-serif;
      }

      .layout {
        display: grid;
        grid-template-columns: 360px minmax(0, 1fr);
        min-height: 100vh;
      }

      .sidebar {
        border-right: 1px solid var(--panel-border);
        background: rgba(5, 17, 31, 0.62);
        backdrop-filter: blur(8px);
        padding: 20px;
      }

      .panel {
        background: var(--panel);
        border: 1px solid var(--panel-border);
        border-radius: 14px;
        padding: 14px;
      }

      .controls {
        display: grid;
        gap: 10px;
      }

      .controls label {
        font-size: 12px;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        color: var(--muted);
      }

      .controls input,
      .controls select,
      .controls textarea {
        width: 100%;
        padding: 10px 11px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: rgba(8, 24, 43, 0.8);
        color: var(--text);
        font-family: 'IBM Plex Mono', monospace;
        font-size: 13px;
      }

      .controls textarea {
        resize: vertical;
        min-height: 84px;
      }

      .buttons {
        display: flex;
        gap: 10px;
      }

      button {
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        padding: 10px 12px;
        background: rgba(13, 36, 63, 0.95);
        color: var(--text);
        font-family: 'Space Grotesk', sans-serif;
        font-weight: 600;
        cursor: pointer;
      }

      button:hover {
        transform: translateY(-1px);
      }

      button.accent {
        border-color: rgba(61, 217, 177, 0.5);
        background: rgba(29, 130, 108, 0.9);
      }

      .queue {
        margin-top: 16px;
        display: grid;
        gap: 10px;
        max-height: calc(100vh - 340px);
        overflow: auto;
      }

      .queue-item {
        border: 1px solid rgba(255, 255, 255, 0.16);
        border-radius: 12px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.04);
        cursor: pointer;
      }

      .queue-item.active {
        border-color: rgba(61, 217, 177, 0.8);
        box-shadow: 0 0 0 2px rgba(61, 217, 177, 0.16) inset;
      }

      .queue-item h4 {
        margin: 0 0 6px;
        font-size: 15px;
      }

      .meta {
        margin: 0;
        color: var(--muted);
        font-size: 12px;
        font-family: 'IBM Plex Mono', monospace;
      }

      .content {
        padding: 24px;
      }

      .header {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        align-items: center;
        justify-content: space-between;
      }

      .header h1 {
        margin: 0;
        font-size: 28px;
        letter-spacing: 0.01em;
      }

      .status-chip {
        display: inline-block;
        border-radius: 999px;
        padding: 5px 10px;
        border: 1px solid rgba(255, 255, 255, 0.22);
        background: rgba(255, 255, 255, 0.05);
        font-family: 'IBM Plex Mono', monospace;
        font-size: 12px;
      }

      .summary {
        margin-top: 16px;
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 10px;
      }

      .summary-card {
        border: 1px solid var(--panel-border);
        border-radius: 12px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.05);
      }

      .summary-card .value {
        margin-top: 6px;
        font-family: 'IBM Plex Mono', monospace;
        font-size: 20px;
      }

      .details {
        margin-top: 14px;
        display: grid;
        grid-template-columns: 1.1fr 0.9fr;
        gap: 12px;
      }

      .stack {
        display: grid;
        gap: 12px;
      }

      .kv {
        display: grid;
        grid-template-columns: 180px 1fr;
        gap: 8px;
        padding: 5px 0;
        border-bottom: 1px dashed rgba(255, 255, 255, 0.13);
        font-size: 13px;
      }

      .kv .key {
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.04em;
        font-size: 11px;
      }

      .docs,
      .events {
        display: grid;
        gap: 8px;
      }

      .doc,
      .event {
        border: 1px solid rgba(255, 255, 255, 0.14);
        border-radius: 10px;
        padding: 10px;
        background: rgba(0, 0, 0, 0.14);
        font-size: 13px;
      }

      .doc a {
        color: #8be7ff;
        word-break: break-all;
      }

      .risk-list {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 8px;
      }

      .risk-chip {
        border-radius: 999px;
        font-size: 11px;
        font-family: 'IBM Plex Mono', monospace;
        padding: 3px 9px;
        background: rgba(255, 191, 90, 0.18);
        border: 1px solid rgba(255, 191, 90, 0.4);
      }

      .review-actions {
        display: grid;
        gap: 10px;
      }

      .review-actions .buttons {
        flex-wrap: wrap;
      }

      .btn-verify {
        background: rgba(29, 130, 69, 0.9);
        border-color: rgba(83, 244, 143, 0.55);
      }

      .btn-manual {
        background: rgba(122, 83, 24, 0.9);
        border-color: rgba(255, 191, 90, 0.5);
      }

      .btn-reject {
        background: rgba(128, 39, 39, 0.9);
        border-color: rgba(255, 95, 95, 0.55);
      }

      .message {
        margin-top: 10px;
        min-height: 20px;
        font-size: 13px;
        font-family: 'IBM Plex Mono', monospace;
      }

      .message.error {
        color: var(--danger);
      }

      .message.ok {
        color: var(--ok);
      }

      @media (max-width: 1080px) {
        .layout {
          grid-template-columns: 1fr;
        }
        .summary {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        .details {
          grid-template-columns: 1fr;
        }
        .queue {
          max-height: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="layout">
      <aside class="sidebar">
        <h2 style="margin: 0 0 14px">Ops Controls</h2>
        <div class="panel controls">
          <label for="apiBase">API Base URL</label>
          <input id="apiBase" value="http://localhost:4000" />

          <label for="adminKey">Admin API Key</label>
          <input id="adminKey" placeholder="x-admin-api-key" />

          <label for="statusFilter">Queue Status</label>
          <select id="statusFilter">
            <option value="DEFAULT">DEFAULT (SUBMITTED + MANUAL_REVIEW)</option>
            <option value="ALL">ALL</option>
            <option value="SUBMITTED">SUBMITTED</option>
            <option value="MANUAL_REVIEW">MANUAL_REVIEW</option>
            <option value="VERIFIED">VERIFIED</option>
            <option value="REJECTED">REJECTED</option>
            <option value="CREATED">CREATED</option>
          </select>

          <label for="queueLimit">Queue Limit</label>
          <input id="queueLimit" type="number" min="1" max="100" value="25" />

          <div class="buttons">
            <button id="refreshQueue" class="accent">Refresh Queue</button>
          </div>
          <p id="queueMsg" class="message"></p>
        </div>

        <div id="queueList" class="queue"></div>
      </aside>

      <main class="content">
        <div class="header">
          <div>
            <h1>KYC Review Command Desk</h1>
            <p style="margin: 8px 0 0; color: var(--muted)">
              Trust-first moderation lane for SDM identity verification.
            </p>
          </div>
          <span id="activeStatusChip" class="status-chip">No session selected</span>
        </div>

        <section id="summary" class="summary"></section>

        <section id="details" class="details" style="display: none">
          <div class="stack">
            <article class="panel">
              <h3 style="margin-top: 0">Session + User</h3>
              <div id="sessionUserBlock"></div>
              <div>
                <strong style="font-size: 12px; color: var(--muted)">Risk Flags</strong>
                <div id="riskFlags" class="risk-list"></div>
              </div>
            </article>

            <article class="panel">
              <h3 style="margin-top: 0">Documents</h3>
              <div id="documentsBlock" class="docs"></div>
            </article>
          </div>

          <div class="stack">
            <article class="panel review-actions">
              <h3 style="margin-top: 0">Review Action</h3>
              <label for="reviewedBy">Reviewed By</label>
              <input id="reviewedBy" placeholder="ops@senpaijepang.com" />
              <label for="reviewReason">Reason</label>
              <textarea id="reviewReason" placeholder="decision notes"></textarea>
              <div class="buttons">
                <button id="decisionManual" class="btn-manual">Set MANUAL_REVIEW</button>
                <button id="decisionVerify" class="btn-verify">Set VERIFIED</button>
                <button id="decisionReject" class="btn-reject">Set REJECTED</button>
              </div>
              <p id="reviewMsg" class="message"></p>
            </article>

            <article class="panel">
              <h3 style="margin-top: 0">Status Events</h3>
              <div id="eventsBlock" class="events"></div>
            </article>
          </div>
        </section>
      </main>
    </div>

    <script>
      const state = {
        queue: [],
        selectedSessionId: null
      };

      const els = {
        apiBase: document.getElementById('apiBase'),
        adminKey: document.getElementById('adminKey'),
        statusFilter: document.getElementById('statusFilter'),
        queueLimit: document.getElementById('queueLimit'),
        refreshQueue: document.getElementById('refreshQueue'),
        queueMsg: document.getElementById('queueMsg'),
        queueList: document.getElementById('queueList'),
        summary: document.getElementById('summary'),
        details: document.getElementById('details'),
        sessionUserBlock: document.getElementById('sessionUserBlock'),
        riskFlags: document.getElementById('riskFlags'),
        documentsBlock: document.getElementById('documentsBlock'),
        eventsBlock: document.getElementById('eventsBlock'),
        activeStatusChip: document.getElementById('activeStatusChip'),
        reviewedBy: document.getElementById('reviewedBy'),
        reviewReason: document.getElementById('reviewReason'),
        reviewMsg: document.getElementById('reviewMsg'),
        decisionManual: document.getElementById('decisionManual'),
        decisionVerify: document.getElementById('decisionVerify'),
        decisionReject: document.getElementById('decisionReject')
      };

      function setMessage(target, message, type) {
        target.textContent = message || '';
        target.className = 'message';
        if (type) {
          target.classList.add(type);
        }
      }

      function getSelectedItem() {
        return state.queue.find((item) => item.session.id === state.selectedSessionId) || null;
      }

      async function apiRequest(path, { method = 'GET', body } = {}) {
        const base = String(els.apiBase.value || '').replace(/\/+$/, '');
        const adminKey = String(els.adminKey.value || '').trim();
        const headers = {};
        if (adminKey) {
          headers['x-admin-api-key'] = adminKey;
        }
        if (body) {
          headers['Content-Type'] = 'application/json';
        }

        const response = await fetch(`${base}${path}`, {
          method,
          headers,
          body: body ? JSON.stringify(body) : undefined
        });

        const text = await response.text();
        const data = text ? JSON.parse(text) : null;
        if (!response.ok) {
          const message = data?.error?.message || `HTTP ${response.status}`;
          throw new Error(message);
        }
        return data;
      }

      function renderSummary() {
        const submitted = state.queue.filter((item) => item.session.status === 'SUBMITTED').length;
        const manual = state.queue.filter((item) => item.session.status === 'MANUAL_REVIEW').length;
        const verified = state.queue.filter((item) => item.session.status === 'VERIFIED').length;
        const rejected = state.queue.filter((item) => item.session.status === 'REJECTED').length;

        const cards = [
          ['Queue Size', state.queue.length],
          ['Submitted', submitted],
          ['Manual Review', manual],
          ['Resolved (V+R)', verified + rejected]
        ];

        els.summary.innerHTML = '';
        for (const [title, value] of cards) {
          const card = document.createElement('div');
          card.className = 'summary-card';
          const label = document.createElement('div');
          label.textContent = title;
          label.style.color = 'var(--muted)';
          label.style.fontSize = '12px';
          const val = document.createElement('div');
          val.className = 'value';
          val.textContent = String(value);
          card.append(label, val);
          els.summary.appendChild(card);
        }
      }

      function renderQueueList() {
        els.queueList.innerHTML = '';
        if (state.queue.length === 0) {
          const empty = document.createElement('p');
          empty.className = 'meta';
          empty.textContent = 'No sessions for selected filter.';
          els.queueList.appendChild(empty);
          return;
        }

        for (const item of state.queue) {
          const card = document.createElement('article');
          card.className = 'queue-item';
          if (item.session.id === state.selectedSessionId) {
            card.classList.add('active');
          }

          const title = document.createElement('h4');
          title.textContent = item.user?.fullName || item.user?.email || item.session.id;

          const status = document.createElement('p');
          status.className = 'meta';
          status.textContent = `${item.session.status} | docs=${item.documentCount}`;

          const secondary = document.createElement('p');
          secondary.className = 'meta';
          secondary.textContent = item.user?.email || 'user not found';

          card.append(title, status, secondary);
          card.addEventListener('click', () => {
            state.selectedSessionId = item.session.id;
            renderAll();
          });

          els.queueList.appendChild(card);
        }
      }

      function kvRow(key, value) {
        const row = document.createElement('div');
        row.className = 'kv';
        const keyNode = document.createElement('div');
        keyNode.className = 'key';
        keyNode.textContent = key;
        const valueNode = document.createElement('div');
        valueNode.textContent = value ?? '-';
        row.append(keyNode, valueNode);
        return row;
      }

      function renderDetails() {
        const selected = getSelectedItem();
        if (!selected) {
          els.details.style.display = 'none';
          els.activeStatusChip.textContent = 'No session selected';
          return;
        }

        els.details.style.display = 'grid';
        els.activeStatusChip.textContent = `${selected.session.status} | ${selected.user?.email || selected.session.id}`;

        els.sessionUserBlock.innerHTML = '';
        els.sessionUserBlock.append(
          kvRow('Session ID', selected.session.id),
          kvRow('Trust Status', selected.trustStatus),
          kvRow('Provider', selected.session.provider),
          kvRow('Submitted At', selected.session.submittedAt || '-'),
          kvRow('Reviewed By', selected.session.reviewedBy || '-'),
          kvRow('User Name', selected.user?.fullName || '-'),
          kvRow('User Email', selected.user?.email || '-')
        );

        els.riskFlags.innerHTML = '';
        if (!selected.riskFlags || selected.riskFlags.length === 0) {
          const safe = document.createElement('span');
          safe.className = 'risk-chip';
          safe.style.background = 'rgba(83, 244, 143, 0.18)';
          safe.style.borderColor = 'rgba(83, 244, 143, 0.45)';
          safe.textContent = 'NO_ACTIVE_FLAGS';
          els.riskFlags.appendChild(safe);
        } else {
          for (const flag of selected.riskFlags) {
            const chip = document.createElement('span');
            chip.className = 'risk-chip';
            chip.textContent = flag;
            els.riskFlags.appendChild(chip);
          }
        }

        els.documentsBlock.innerHTML = '';
        if (selected.documents.length === 0) {
          const emptyDoc = document.createElement('div');
          emptyDoc.className = 'doc';
          emptyDoc.textContent = 'No documents uploaded.';
          els.documentsBlock.appendChild(emptyDoc);
        } else {
          for (const doc of selected.documents) {
            const docBox = document.createElement('div');
            docBox.className = 'doc';
            docBox.append(
              kvRow('Type', doc.documentType),
              kvRow('Object Key', doc.objectKey || '-'),
              kvRow('Checksum', doc.checksumSha256),
              kvRow('Created At', doc.createdAt || '-')
            );
            const link = document.createElement('a');
            link.href = doc.fileUrl;
            link.target = '_blank';
            link.rel = 'noreferrer noopener';
            link.textContent = doc.fileUrl;
            docBox.appendChild(link);
            els.documentsBlock.appendChild(docBox);
          }
        }

        els.eventsBlock.innerHTML = '';
        if (!selected.lastEvent && (!selected.events || selected.events.length === 0)) {
          const emptyEvent = document.createElement('div');
          emptyEvent.className = 'event';
          emptyEvent.textContent = 'No events logged.';
          els.eventsBlock.appendChild(emptyEvent);
          return;
        }

        const events = selected.events || (selected.lastEvent ? [selected.lastEvent] : []);
        for (const event of events) {
          const eventBox = document.createElement('div');
          eventBox.className = 'event';
          const title = document.createElement('strong');
          title.textContent = `${event.fromStatus || '-'} -> ${event.toStatus}`;
          const meta = document.createElement('p');
          meta.className = 'meta';
          meta.textContent = `${event.actorType} | ${event.actorId || '-'} | ${event.createdAt || '-'}`;
          const reason = document.createElement('p');
          reason.style.margin = '6px 0 0';
          reason.textContent = event.reason || 'no reason';
          eventBox.append(title, meta, reason);
          els.eventsBlock.appendChild(eventBox);
        }
      }

      function renderAll() {
        renderSummary();
        renderQueueList();
        renderDetails();
      }

      async function loadQueue() {
        setMessage(els.queueMsg, 'Loading queue...');
        try {
          const status = encodeURIComponent(els.statusFilter.value || 'DEFAULT');
          const limit = encodeURIComponent(els.queueLimit.value || '25');
          const data = await apiRequest(`/admin/kyc/review-queue?status=${status}&limit=${limit}`);
          state.queue = data.items;
          if (!state.selectedSessionId || !state.queue.some((item) => item.session.id === state.selectedSessionId)) {
            state.selectedSessionId = state.queue[0]?.session.id || null;
          }
          setMessage(els.queueMsg, `Queue loaded (${data.count} items)`, 'ok');
          renderAll();
        } catch (error) {
          setMessage(els.queueMsg, error.message, 'error');
        }
      }

      async function submitDecision(decision) {
        const selected = getSelectedItem();
        if (!selected) {
          setMessage(els.reviewMsg, 'Select a session first.', 'error');
          return;
        }

        const reviewedBy = String(els.reviewedBy.value || '').trim();
        if (!reviewedBy) {
          setMessage(els.reviewMsg, 'Reviewed By is required.', 'error');
          return;
        }

        setMessage(els.reviewMsg, `Submitting ${decision}...`);
        try {
          await apiRequest('/admin/kyc/review', {
            method: 'POST',
            body: {
              sessionId: selected.session.id,
              decision,
              reviewedBy,
              reason: String(els.reviewReason.value || '').trim() || undefined
            }
          });
          setMessage(els.reviewMsg, `Decision ${decision} saved.`, 'ok');
          await loadQueue();
        } catch (error) {
          setMessage(els.reviewMsg, error.message, 'error');
        }
      }

      els.refreshQueue.addEventListener('click', loadQueue);
      els.statusFilter.addEventListener('change', loadQueue);
      els.decisionManual.addEventListener('click', () => submitDecision('MANUAL_REVIEW'));
      els.decisionVerify.addEventListener('click', () => submitDecision('VERIFIED'));
      els.decisionReject.addEventListener('click', () => submitDecision('REJECTED'));

      renderAll();
    </script>
  </body>
</html>
